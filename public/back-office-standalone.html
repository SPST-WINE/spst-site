<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SPST • Back Office</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- CSS base + preventivi (PATH CORRETTI) -->
<link rel="stylesheet" href="https://spst-logistics.vercel.app/back-office/base.css?v=1">
<link rel="stylesheet" href="https://spst-logistics.vercel.app/back-office/quotes-admin.css?v=1">


  <!-- Patch UI locali -->
  <style>
    /* Spazio extra sopra “Colli” */
    #qa-packages { margin-top:16px; }

    /* Griglia “Colli”: head e righe DEVONO combaciare */
    :root{ --pkg-grid: 110px 1fr 1fr 1fr 120px 90px; }
    #qa-packages .pkg-head{
      display:grid; grid-template-columns:var(--pkg-grid);
      gap:8px; padding:6px 0; align-items:center;
    }
    #qa-packages .pkg-head > div{ text-align:left; }

    /* Forza le righe ad allinearsi alla testa */
    #qa-packages .pkg-row{
      display:grid !important; grid-template-columns:var(--pkg-grid) !important;
      gap:8px; margin:6px 0; align-items:center;
    }
    #qa-packages .pkg-row > *{ min-width:0; } /* evita overflow */

    /* Input full-width nelle celle */
    #qa-packages .pkg-row input[type="text"],
    #qa-packages .pkg-row input[type="number"]{ width:100%; }

    /* Nascondi placeholder (se presenti) */
    #qa-packages .pkg-row input::placeholder{ color:transparent !important; }

    /* Nascondi qualunque bottone legacy della riga (quello bianco) */
    #qa-packages .pkg-row input[type="button"],
    #qa-packages .pkg-row button:not(.pkg-remove){ display:none !important; }

    /* Pulsante “Elimina” coerente col tema */
    #qa-packages .pkg-row .pkg-remove{
      width:100%; height:36px; border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06); color:#e7ecf5;
      cursor:pointer; user-select:none; font-weight:600;
      display:flex; align-items:center; justify-content:center;
      transition:background .15s ease, border-color .15s ease, transform .06s ease;
    }
    #qa-packages .pkg-row .pkg-remove:hover{
      background:rgba(255,255,255,.10); border-color:rgba(255,255,255,.18);
    }
    #qa-packages .pkg-row .pkg-remove:active{ transform:translateY(1px); }

    /* P.IVA/EORI a tutta riga */
    .qa-inner .fullrow{ grid-column:1 / -1; }
  </style>
</head>
<body>

  <!-- ancore (legacy) -->
  <a id="tab-spedizioni" class="anchor" aria-hidden="true"></a>
  <a id="tab-preventivi" class="anchor" aria-hidden="true"></a>

  <!-- BRAND BAR -->
  <div class="brandbar">
    <div class="wrap" style="display:flex;align-items:center;gap:12px">
      <div class="brand-left" style="display:flex;align-items:center;gap:12px">
        <img class="logo" src="https://cdn.prod.website-files.com/6800cc3b5f399f3e2b7f2ffa/68079e968300482f70a36a4a_output-onlinepngtools%20(1).png" alt="SPST logo" />
        <div class="divider" aria-hidden="true"></div>
        <div class="title">Back Office</div>
      </div>
      <a href="https://spst-logistics.vercel.app/api/tools/docs"
         target="_blank" rel="noopener"
         class="link-orange"
         style="margin-left:auto">Utility Documenti</a>
    </div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="wrap">
      <div class="toolbar">
        <div class="toolbar-left">
          <input id="search" type="text" placeholder="Cerca per ID spedizione o cliente…" />
        </div>
        <div class="toolbar-right">
          <label class="chip small"><input id="only-open" type="checkbox"> Solo non evase</label>
        </div>
      </div>

      <div class="hairline"></div>
      <div class="tabbar" style="margin-top:10px">
        <a href="#tab-spedizioni" data-tab="spedizioni" class="is-active">Spedizioni</a>
        <a href="#tab-preventivi" data-tab="preventivi">Preventivi</a>
      </div>
    </div>
  </header>

  <!-- Banner API -->
  <div id="api-banner" class="banner">
    Impossibile raggiungere il proxy API. Sto mostrando la lista vuota.
    <span class="small">(controlla ORIGIN_ALLOWLIST su Vercel e la connettività)</span>
  </div>

  <!-- MAIN -->
  <main class="wrap">
    <!-- PREVENTIVI -->
    <section id="view-preventivi" class="view" style="display:none">
      <div id="quotes-admin">
        <div class="qa-header">
          <div>
            <div class="qa-breadcrumbs">Preventivi / Nuovo</div>
            <h2 class="qa-title">Crea Preventivo</h2>
          </div>
          <div class="qa-toolbar">
            <button class="btn ghost" title="Salva bozza" data-action="draft">Salva bozza</button>
            <button class="btn primary" title="Crea preventivo" disabled data-action="create">Crea preventivo</button>
          </div>
        </div>

        <div class="qa-split">
          <section class="card">
            <h3 class="qa-h">Dati cliente</h3>
            <div class="qa-grid qa-cols-3">
              <div>
                <label class="qa-label">Email cliente*</label>
                <input id="customer-email" placeholder="buyer@azienda.com" />
              </div>
              <div>
                <label class="qa-label">Valuta</label>
                <select id="quote-currency">
                  <option>EUR</option><option>USD</option><option>GBP</option>
                </select>
              </div>
              <div>
                <label class="qa-label">Validità preventivo</label>
                <input id="quote-validity" type="date" />
              </div>
            </div>
            <label class="qa-label" style="margin-top:8px">Note globali (visibili al cliente)</label>
            <textarea id="quote-notes" rows="3" placeholder="Es. documenti richiesti, restrizioni Paese, cut-off ritiro…"></textarea>
          </section>

          <aside class="card qa-sticky">
            <h3 class="qa-h">Riepilogo</h3>
            <div class="qa-keyval"><div class="k">Cliente</div><div id="sum-customer">—</div></div>
            <div class="qa-keyval"><div class="k">Validità</div><div id="sum-validity">—</div></div>
            <div class="qa-keyval"><div class="k">Valuta</div><div id="sum-currency">EUR</div></div>
            <div class="qa-divider"></div>
            <div class="qa-keyval"><div class="k">Colli</div><div id="sum-packages">—</div></div>
            <div class="qa-divider"></div>
            <div class="qa-keyval"><div class="k">Consigliata</div><div id="sum-best">—</div></div>
            <div class="qa-divider"></div>
            <div class="small">Il riepilogo verrà popolato automaticamente mentre compili.</div>
          </aside>
        </div>

        <section class="card" style="margin-top:16px">
          <h3 class="qa-h">Dati spedizione (mittente & destinatario)</h3>
          <div class="qa-grid qa-cols-2">
            <div class="card qa-inner">
              <h4 class="qa-sub">Mittente</h4>
              <div class="qa-grid qa-cols-2">
                <div><label class="qa-label">Ragione sociale / Nome*</label><input placeholder="Cantina Rossi Srl" data-field="sender_name" /></div>
                <div><label class="qa-label">Paese</label><input placeholder="Italia" data-field="sender_country" /></div>
                <div><label class="qa-label">Città</label><input placeholder="Firenze" data-field="sender_city" /></div>
                <div><label class="qa-label">CAP</label><input placeholder="50100" data-field="sender_zip" /></div>
                <div><label class="qa-label">Indirizzo</label><input placeholder="Via esempio 12" data-field="sender_address" /></div>
                <div><label class="qa-label">Telefono</label><input placeholder="+39 …" data-field="sender_phone" /></div>
                <div class="fullrow"><label class="qa-label">P. IVA / EORI</label><input placeholder="ITxxxxxxxxxxx / EORI…" data-field="sender_tax" /></div>
              </div>
            </div>
            <div class="card qa-inner">
              <h4 class="qa-sub">Destinatario</h4>
              <div class="qa-grid qa-cols-2">
                <div><label class="qa-label">Ragione sociale / Nome*</label><input placeholder="Wine Import LLC" data-field="rcpt_name" /></div>
                <div><label class="qa-label">Paese</label><input placeholder="USA" data-field="rcpt_country" /></div>
                <div><label class="qa-label">Città</label><input placeholder="New York" data-field="rcpt_city" /></div>
                <div><label class="qa-label">ZIP</label><input placeholder="10001" data-field="rcpt_zip" /></div>
                <div><label class="qa-label">Indirizzo</label><input placeholder="Street, number" data-field="rcpt_address" /></div>
                <div><label class="qa-label">Telefono</label><input placeholder="+1 …" data-field="rcpt_phone" /></div>
                <div class="fullrow"><label class="qa-label">Tax ID / EORI</label><input placeholder="EIN / EORI" data-field="rcpt_tax" /></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Card: Colli -->
        <section class="card" id="qa-packages">
          <h3 class="qa-h">Colli</h3>

          <div id="qa-pkg-totals" class="small">
            Totale colli: 0 · Peso reale totale: 0.00 kg
          </div>

          <!-- header colonne -->
          <div class="pkg-head" style="display:grid;grid-template-columns:120px repeat(3,1fr) 140px 80px;gap:8px;margin:8px 0 6px">
            <div>Quantità</div><div>Lato 1</div><div>Lato 2</div><div>Lato 3</div><div>Peso (Kg)</div><div></div>
          </div>

          <!-- righe generate via JS -->
          <div id="qa-pkg-rows"></div>

          <button id="qa-pkg-add" type="button" class="btn" style="margin-top:10px">+ Aggiungi collo</button>
        </section>

        <!-- OPZIONI -->
        <section class="card" style="margin-top:16px">
          <h3 class="qa-h">Opzioni di spedizione</h3>

          <div class="qa-grid qa-cols-2">
            <!-- OPZIONE 1 -->
            <div class="card qa-option" data-option="1">
              <div class="qa-opt-head">
                <div class="qa-badge">OPZIONE 1</div>
                <label class="qa-recommend">
                  <input type="radio" name="bestOption" value="1" />
                  <span class="qa-recommend-ui"><span class="dot"></span><span class="txt">Consiglia questa opzione</span></span>
                </label>
              </div>

              <div class="qa-grid qa-cols-2">
                <div><label class="qa-label">Corriere*</label><select class="qa-carrier"></select></div>
                <div><label class="qa-label">Servizio*</label><input class="qa-service" placeholder="Express / Economy" /></div>

                <div style="grid-column:1 / -1">
                  <label class="qa-label">Tempo di resa previsto*</label>
                  <input class="qa-transit" placeholder="es. 2–5 giorni" />
                </div>

                <div><label class="qa-label">Incoterm*</label><select class="qa-incoterm"></select></div>
                <div><label class="qa-label">Oneri a carico di*</label>
                  <select class="qa-payer"><option>Mittente</option><option>Destinatario</option></select>
                </div>

                <div><label class="qa-label">Prezzo*</label>
                  <input class="qa-price" type="number" step="0.01" placeholder="es. 120.00" />
                </div>
                <div><label class="qa-label">Valuta</label>
                  <select class="qa-currency"><option>EUR</option><option>USD</option><option>GBP</option></select>
                </div>
              </div>

              <label class="qa-label">Note operative</label>
              <textarea class="qa-notes" rows="2" placeholder="Es. ritiro su appuntamento, documenti extra, vincoli orari…"></textarea>
            </div>

            <!-- OPZIONE 2 -->
            <div class="card qa-option" data-option="2">
              <div class="qa-opt-head">
                <div class="qa-badge">OPZIONE 2</div>
                <label class="qa-recommend">
                  <input type="radio" name="bestOption" value="2" />
                  <span class="qa-recommend-ui"><span class="dot"></span><span class="txt">Consiglia questa opzione</span></span>
                </label>
              </div>

              <div class="qa-grid qa-cols-2">
                <div><label class="qa-label">Corriere*</label><select class="qa-carrier"></select></div>
                <div><label class="qa-label">Servizio*</label><input class="qa-service" placeholder="Express / Economy" /></div>

                <div style="grid-column:1 / -1">
                  <label class="qa-label">Tempo di resa previsto*</label>
                  <input class="qa-transit" placeholder="es. 3–7 giorni" />
                </div>

                <div><label class="qa-label">Incoterm*</label><select class="qa-incoterm"></select></div>
                <div><label class="qa-label">Oneri a carico di*</label>
                  <select class="qa-payer"><option>Mittente</option><option>Destinatario</option></select>
                </div>

                <div><label class="qa-label">Prezzo*</label>
                  <input class="qa-price" type="number" step="0.01" placeholder="es. 140.00" />
                </div>
                <div><label class="qa-label">Valuta</label>
                  <select class="qa-currency"><option>EUR</option><option>USD</option><option>GBP</option></select>
                </div>
              </div>

              <label class="qa-label">Note operative</label>
              <textarea class="qa-notes" rows="2" placeholder="Es. surcharge carburante, restrizioni…"></textarea>
            </div>
          </div>
        </section>

        <section class="card" style="margin-top:16px">
          <h3 class="qa-h">Termini & visibilità</h3>
          <div class="qa-grid qa-cols-3">
            <div><label class="qa-label">Versione termini</label><select id="terms-version"><option>v1.0 (corrente)</option><option>v0.9</option></select></div>
            <div>
              <label class="qa-label">Visibilità link pubblico</label>
              <select id="link-visibility">
                <option value="Immediata">Subito</option>
                <option value="Solo_Bozza">Solo bozza (non condividere)</option>
              </select>
            </div>
            <div><label class="qa-label">Scadenza link (giorni)</label><input id="link-expiry" type="number" placeholder="14" /></div>
          </div>
          <div class="qa-toolbar">
            <button class="btn ghost" id="btn-preview" disabled>Anteprima cliente</button>
            <button class="btn primary" id="btn-create" title="Crea preventivo" disabled data-action="create">Crea preventivo</button>
          </div>
        </section>
      </div>
    </section>

    <!-- SPEDIZIONI -->
    <section id="view-spedizioni">
      <div id="list" class="grid"></div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- Config + Hotfix PATCH -->
  <script>
    window.BACK_OFFICE_CONFIG = {
      PROXY_BASE: 'https://spst-logistics.vercel.app/api/airtable',
      DEBUG: true,
      CARRIERS: ['DHL','FedEx','UPS','TNT','Privato'],
      INCOTERMS: ['EXW','DAP','DDP']
    };
    (function(){
      const origFetch = window.fetch;
      window.fetch = async function(input, init = {}) {
        try {
          const url = (typeof input === 'string') ? input : (input && input.url) || '';
          const method = (init && init.method || 'GET').toUpperCase();
          if (method === 'PATCH' && /\/api\/airtable\/spedizioni\/[^/]+$/.test(url)) {
            if (typeof init.body === 'string' && init.body.trim().startsWith('{')) {
              const body = JSON.parse(init.body);
              if (!body.fields || typeof body.fields !== 'object') body.fields = {};
              const KNOWN = new Set(['carrier','tracking','statoEvasa','docs','fields']);
              Object.keys(body).forEach(k => { if (!KNOWN.has(k)) { body.fields[k] = body[k]; delete body[k]; } });
              const ALIAS = new Set(['e-DAS','e_DAS','eDAS','EDAS']);
              for (const a of ALIAS) {
                if (body.fields[a]) { body.fields['Allegato 3'] = body.fields[a]; delete body.fields[a]; }
                if (body[a])       { body.fields['Allegato 3'] = body[a];       delete body[a]; }
              }
              init.body = JSON.stringify(body);
              console.log('[PatchInterceptor] PATCH normalizzato →', body);
            }
          }
        } catch(e){ console.warn('[PatchInterceptor] non applicato:', e); }
        return origFetch(input, init);
      };
    })();
  </script>

  <!-- JS ESM dal progetto spst-logistics -->
  <script type="module" crossorigin src="https://spst-logistics.vercel.app/assets/esm/main.js?v=1"></script>
  <script type="module" crossorigin src="https://spst-logistics.vercel.app/assets/esm/quotes-admin.js?v=1"></script>
  <script type="module" crossorigin src="https://spst-logistics.vercel.app/assets/esm/back-office-tabs.js?v=1"></script>
  <script type="module" crossorigin src="https://spst-logistics.vercel.app/assets/esm/brandbar-offset.js?v=1"></script>
</body>
</html>
